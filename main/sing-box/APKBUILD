# Contributor: Anon <danilagdn.2004@gmail.com>
# Maintainer: Anon <danilagdn.2004@gmail.com>
pkgname=sing-box
pkgver=1.10.1
pkgrel=0
pkgdesc="The universal proxy platform"
url="https://sing-box.sagernet.org/"
arch="all"
license="GPL-3.0-or-later with name use or association addition"
makedepends="go"
subpackages="$pkgname-openrc $pkgname-bash-completion"
options="net" # go modules
source="$pkgname-$pkgver.tar.gz::https://github.com/SagerNet/sing-box/archive/v$pkgver.tar.gz
	$pkgname.initd
	"
_tags="with_gvisor,with_quic,with_wireguard,with_utls,with_reality_server,with_clash_api,with_ech,with_dhcp,with_acme"

build() {
	export CGO_CPPFLAGS="$CPPFLAGS"
	export CGO_CFLAGS="$CFLAGS"
	export CGO_CXXFLAGS="$CXXFLAGS"
	export CGO_LDFLAGS="$LDFLAGS"

	go build -v -tags "$_tags" \
	-ldflags "-X \"github.com/sagernet/sing-box/constant.Version=$pkgver\" -s -w
	-buildid= -linkmode=external" ./cmd/sing-box

	install -d completions
	go run ./cmd/sing-box completion bash   > completions/bash
}

check() {
	go test -v ./...
	# require docker to run test cases in the "test" submodule,
	# some checks are ignored in the upstream Makefile.
}

package() {
	install -Dm644 LICENSE                      -t "$pkgdir/usr/share/licenses/$pkgname"
	install -Dm755 "$pkgname"                   -t "$pkgdir/usr/bin"
	install -Dm644 "release/config/config.json" -t "$pkgdir/etc/$pkgname"
	install -Dm755 "$srcdir/$pkgname.initd" 		"$pkgdir/etc/init.d/$pkgname"

	install -Dm644 completions/bash "$pkgdir/usr/share/bash-completion/completions/$pkgname.bash"

}

sha512sums="
def0f28901a9f432c5a43bfd2b8cd9f83832a2f4487abcc786c6c046ec1c66ac7b8dbe4db6f89eecefd042152056181b3006f4c1e61af814761d105e8625d76a  sing-box-1.10.1.tar.gz
f776cea8562d0dcfb5a32a58aa3d3ffd631194c4bf72919852d8482baf2cf008012a0862df45e9a6e8c626b373238d8dfbbcfbe5412e2302b9ad2bfc81dc11f5  sing-box.initd
"
